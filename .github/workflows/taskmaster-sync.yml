# Task Master â†’ GitHub Issues Sync
# This GitHub Action watches .taskmaster/tasks.json and syncs changes to GitHub Issues

name: Sync Task Master to GitHub Issues

on:
  push:
    paths:
      - '.taskmaster/tasks.json'
    branches:
      - main
      - master

  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all tasks (ignore cache)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-tasks:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Sync Task Master to GitHub Issues
        uses: actions/github-script@v7
        env:
          FORCE_SYNC: ${{ github.event.inputs.force_sync || 'false' }}
        with:
          script: |
            const fs = require('fs');
            
            const STATUS_MAP = {
              'pending': { state: 'open', labels: ['tm-task', 'tm-pending'] },
              'in-progress': { state: 'open', labels: ['tm-task', 'tm-in-progress'] },
              'done': { state: 'closed', labels: ['tm-task', 'tm-done'] },
              'blocked': { state: 'open', labels: ['tm-task', 'tm-blocked'] },
              'deferred': { state: 'open', labels: ['tm-task', 'tm-deferred'] },
              'cancelled': { state: 'closed', labels: ['tm-task', 'tm-cancelled'] },
              'review': { state: 'open', labels: ['tm-task', 'tm-review'] }
            };
            
            const PRIORITY_LABELS = {
              'high': 'priority-high',
              'medium': 'priority-medium', 
              'low': 'priority-low'
            };
            
            let tasks;
            try {
              const content = fs.readFileSync('.taskmaster/tasks.json', 'utf8');
              tasks = JSON.parse(content);
            } catch (err) {
              console.log('No tasks.json found or invalid JSON');
              return;
            }
            
            if (!tasks.tasks || !Array.isArray(tasks.tasks)) {
              console.log('No tasks array found');
              return;
            }
            
            const requiredLabels = [
              { name: 'tm-task', color: '0366d6', description: 'Task Master synced task' },
              { name: 'tm-pending', color: 'fbca04', description: 'Task status: pending' },
              { name: 'tm-in-progress', color: '0e8a16', description: 'Task status: in progress' },
              { name: 'tm-done', color: '6f42c1', description: 'Task status: done' },
              { name: 'tm-blocked', color: 'd73a4a', description: 'Task status: blocked' },
              { name: 'tm-deferred', color: 'c5def5', description: 'Task status: deferred' },
              { name: 'tm-cancelled', color: 'e4e669', description: 'Task status: cancelled' },
              { name: 'tm-review', color: 'f9d0c4', description: 'Task status: review' },
              { name: 'priority-high', color: 'b60205', description: 'High priority' },
              { name: 'priority-medium', color: 'fbca04', description: 'Medium priority' },
              { name: 'priority-low', color: '0e8a16', description: 'Low priority' }
            ];
            
            const existingLabels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const existingNames = existingLabels.data.map(l => l.name);
            
            for (const label of requiredLabels) {
              if (!existingNames.includes(label.name)) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ...label
                  });
                  console.log(`Created label: ${label.name}`);
                } catch (e) {
                  console.log(`Label ${label.name} may already exist`);
                }
              }
            }
            
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'tm-task',
              state: 'all',
              per_page: 100
            });
            
            const taskIssueMap = new Map();
            for (const issue of existingIssues.data) {
              const match = issue.body?.match(/<!-- tm:(\d+(?:\.\d+)?) -->/);
              if (match) {
                taskIssueMap.set(match[1], issue.number);
              }
            }
            
            for (const task of tasks.tasks) {
              const taskId = String(task.id);
              const statusConfig = STATUS_MAP[task.status] || STATUS_MAP['pending'];
              
              const labels = [...statusConfig.labels];
              if (task.priority && PRIORITY_LABELS[task.priority]) {
                labels.push(PRIORITY_LABELS[task.priority]);
              }
              
              let subtasksMarkdown = '';
              if (task.subtasks && task.subtasks.length > 0) {
                subtasksMarkdown = '\n### Subtasks\n';
                for (const sub of task.subtasks) {
                  const checked = sub.status === 'done' ? 'x' : ' ';
                  subtasksMarkdown += `- [${checked}] **${sub.id}**: ${sub.title}\n`;
                }
              }
              
              let depsMarkdown = '';
              if (task.dependencies && task.dependencies.length > 0) {
                depsMarkdown = `**Dependencies:** ${task.dependencies.map(d => `#${d}`).join(', ')}\n\n`;
              }
              
              const body = `## Task Master Task #${taskId}\n\n**Status:** ${task.status}\n**Priority:** ${task.priority || 'medium'}\n${depsMarkdown}\n### Description\n${task.description || task.title}\n\n### Details\n${task.details || '_No additional details_'}\n${subtasksMarkdown}\n---\n*Synced from Task Master AI*\n<!-- tm:${taskId} -->`;
              
              const existingIssueNumber = taskIssueMap.get(taskId);
              
              if (existingIssueNumber) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssueNumber,
                  title: task.title,
                  body: body,
                  state: statusConfig.state,
                  labels: labels
                });
                console.log(`Updated issue #${existingIssueNumber} for task ${taskId}`);
              } else {
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: task.title,
                  body: body,
                  labels: labels
                });
                console.log(`Created issue #${newIssue.data.number} for task ${taskId}`);
                
                if (statusConfig.state === 'closed') {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: newIssue.data.number,
                    state: 'closed'
                  });
                }
              }
            }
            
            console.log(`Synced ${tasks.tasks.length} tasks to GitHub Issues`);