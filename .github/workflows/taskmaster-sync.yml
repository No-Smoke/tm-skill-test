# Task Master â†’ GitHub Issues + Plane Sync
name: Sync Task Master to GitHub Issues + Plane

on:
  push:
    paths:
      - '.taskmaster/tasks.json'
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all tasks'
        required: false
        default: 'false'
        type: boolean
      skip_plane:
        description: 'Skip Plane sync'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-tasks:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync Task Master to GitHub Issues
        id: github-sync
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const STATUS_MAP = {
              'pending': { state: 'open', labels: ['tm-task', 'tm-pending'] },
              'in-progress': { state: 'open', labels: ['tm-task', 'tm-in-progress'] },
              'done': { state: 'closed', labels: ['tm-task', 'tm-done'] },
              'blocked': { state: 'open', labels: ['tm-task', 'tm-blocked'] },
              'cancelled': { state: 'closed', labels: ['tm-task', 'tm-cancelled'] }
            };
            const PRIORITY_LABELS = { 'high': 'priority-high', 'medium': 'priority-medium', 'low': 'priority-low' };
            
            let tasks;
            try {
              tasks = JSON.parse(fs.readFileSync('.taskmaster/tasks.json', 'utf8'));
            } catch (err) {
              console.log('No tasks.json found');
              return;
            }
            if (!tasks.tasks) return;
            
            const requiredLabels = [
              { name: 'tm-task', color: '0366d6', description: 'Task Master task' },
              { name: 'tm-pending', color: 'fbca04', description: 'Pending' },
              { name: 'tm-in-progress', color: '0e8a16', description: 'In progress' },
              { name: 'tm-done', color: '6f42c1', description: 'Done' },
              { name: 'tm-blocked', color: 'd73a4a', description: 'Blocked' },
              { name: 'tm-cancelled', color: 'e4e669', description: 'Cancelled' },
              { name: 'priority-high', color: 'b60205', description: 'High priority' },
              { name: 'priority-medium', color: 'fbca04', description: 'Medium priority' },
              { name: 'priority-low', color: '0e8a16', description: 'Low priority' }
            ];
            
            const existingLabels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner, repo: context.repo.repo
            });
            const existingNames = existingLabels.data.map(l => l.name);
            
            for (const label of requiredLabels) {
              if (!existingNames.includes(label.name)) {
                try {
                  await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, ...label });
                } catch (e) { }
              }
            }
            
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, labels: 'tm-task', state: 'all', per_page: 100
            });
            
            const taskIssueMap = new Map();
            for (const issue of existingIssues.data) {
              const match = issue.body?.match(/<!-- tm:(\d+) -->/);
              if (match) taskIssueMap.set(match[1], issue.number);
            }
            
            for (const task of tasks.tasks) {
              const taskId = String(task.id);
              const statusConfig = STATUS_MAP[task.status] || STATUS_MAP['pending'];
              const labels = [...statusConfig.labels];
              if (task.priority && PRIORITY_LABELS[task.priority]) labels.push(PRIORITY_LABELS[task.priority]);
              
              const body = [
                '## Task Master Task #' + taskId,
                '',
                '**Status:** ' + task.status,
                '**Priority:** ' + (task.priority || 'medium'),
                '',
                '### Description',
                task.description || task.title,
                '',
                '### Details',
                task.details || '_No details_',
                '',
                '---',
                '_Synced from Task Master AI_',
                '<!-- tm:' + taskId + ' -->'
              ].join('\n');
              
              const existingIssueNumber = taskIssueMap.get(taskId);
              
              if (existingIssueNumber) {
                await github.rest.issues.update({
                  owner: context.repo.owner, repo: context.repo.repo,
                  issue_number: existingIssueNumber, title: task.title, body: body,
                  state: statusConfig.state, labels: labels
                });
                console.log('Updated issue #' + existingIssueNumber + ' for task ' + taskId);
              } else {
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner, repo: context.repo.repo,
                  title: task.title, body: body, labels: labels
                });
                console.log('Created issue #' + newIssue.data.number + ' for task ' + taskId);
                if (statusConfig.state === 'closed') {
                  await github.rest.issues.update({
                    owner: context.repo.owner, repo: context.repo.repo,
                    issue_number: newIssue.data.number, state: 'closed'
                  });
                }
              }
            }
            console.log('Synced ' + tasks.tasks.length + ' tasks to GitHub Issues');

      - name: Sync to Plane
        if: vars.PLANE_WORKSPACE_SLUG != ''
        env:
          PLANE_API_KEY: ${{ secrets.PLANE_API_KEY }}
          PLANE_BASE_URL: ${{ vars.PLANE_BASE_URL }}
          PLANE_WORKSPACE_SLUG: ${{ vars.PLANE_WORKSPACE_SLUG }}
          PLANE_PROJECT_ID: ${{ vars.PLANE_PROJECT_ID }}
        run: |
          if [ -z "$PLANE_API_KEY" ] || [ -z "$PLANE_PROJECT_ID" ]; then
            echo "Plane not configured, skipping"
            exit 0
          fi
          
          echo "Syncing to Plane: $PLANE_WORKSPACE_SLUG"
          
          STATES=$(curl -s -H "X-API-Key: $PLANE_API_KEY" \
            "$PLANE_BASE_URL/api/v1/workspaces/$PLANE_WORKSPACE_SLUG/projects/$PLANE_PROJECT_ID/states/")
          
          BACKLOG=$(echo "$STATES" | jq -r '.results[] | select(.group == "backlog") | .id' | head -1)
          STARTED=$(echo "$STATES" | jq -r '.results[] | select(.group == "started") | .id' | head -1)
          DONE=$(echo "$STATES" | jq -r '.results[] | select(.group == "completed") | .id' | head -1)
          
          EXISTING=$(curl -s -H "X-API-Key: $PLANE_API_KEY" \
            "$PLANE_BASE_URL/api/v1/workspaces/$PLANE_WORKSPACE_SLUG/projects/$PLANE_PROJECT_ID/work-items/?per_page=100")
          
          jq -c '.tasks[]' .taskmaster/tasks.json | while read -r task; do
            TID=$(echo "$task" | jq -r '.id')
            TITLE=$(echo "$task" | jq -r '.title')
            STATUS=$(echo "$task" | jq -r '.status')
            DESC=$(echo "$task" | jq -r '.description // .title')
            
            case "$STATUS" in
              "in-progress") STATE="$STARTED" ;;
              "done") STATE="$DONE" ;;
              *) STATE="$BACKLOG" ;;
            esac
            
            EXT_ID="tm-$TID"
            EXIST_ID=$(echo "$EXISTING" | jq -r --arg eid "$EXT_ID" '.results[] | select(.external_id == $eid) | .id' | head -1)
            
            PAYLOAD=$(jq -n --arg n "$TITLE" --arg d "<p>$DESC</p>" --arg s "$STATE" --arg e "$EXT_ID" \
              '{name:$n, description_html:$d, state:$s, external_id:$e, external_source:"taskmaster"}')
            
            if [ -n "$EXIST_ID" ] && [ "$EXIST_ID" != "null" ]; then
              echo "Updating Plane item $EXIST_ID for task $TID"
              curl -s -X PATCH -H "X-API-Key: $PLANE_API_KEY" -H "Content-Type: application/json" \
                "$PLANE_BASE_URL/api/v1/workspaces/$PLANE_WORKSPACE_SLUG/projects/$PLANE_PROJECT_ID/work-items/$EXIST_ID/" \
                -d "$PAYLOAD" > /dev/null
            else
              echo "Creating Plane item for task $TID"
              curl -s -X POST -H "X-API-Key: $PLANE_API_KEY" -H "Content-Type: application/json" \
                "$PLANE_BASE_URL/api/v1/workspaces/$PLANE_WORKSPACE_SLUG/projects/$PLANE_PROJECT_ID/work-items/" \
                -d "$PAYLOAD" > /dev/null
            fi
          done
          echo "Plane sync complete"
